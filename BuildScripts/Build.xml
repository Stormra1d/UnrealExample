<BuildGraph xmlns="http://www.epicgames.com/BuildGraph" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.epicgames.com/BuildGraph ../Schema.xsd">
  
  <!-- Configuration -->
  <Option Name="ProjectName" DefaultValue="" Description="Name of the project" />
  <Option Name="ProjectRoot" DefaultValue="" Description="Root directory of the project" />

  <Property Name="ProjectFile" Value="$(ProjectRoot)\$(ProjectName).uproject" />
  <Property Name="BuildOutputDir" Value="$(ProjectRoot)\Saved\StagedBuilds" />
  <Property Name="AutomationOutDir" Value="$(ProjectRoot)\Saved\Automation" />

  <Error Message="Project file $(ProjectFile) does not exist" If="!Exists('$(ProjectFile)')" />
  <Error Message="ProjectName must be specified via -set:ProjectName=..." If="'$(ProjectName)' == ''" />
  <Error Message="ProjectRoot must be specified via -set:ProjectRoot=..." If="'$(ProjectRoot)' == ''" />

  <!-- Build Configuration -->
  <Option Name="BuildConfiguration" DefaultValue="Development" Restrict="Debug|Development|Shipping|Test" Description="Build configuration" />
  <Option Name="TargetPlatform" DefaultValue="Win64" Restrict="Win64|Linux|Mac" Description="Target platform for builds" />
  
  <Option Name="EnableEditor" DefaultValue="true" Restrict="true|false" Description="Build the editor" />
  <Option Name="EnableGameBuild" DefaultValue="true" Restrict="true|false" Description="Build the game target" />
  <Option Name="EnableCook" DefaultValue="true" Restrict="true|false" Description="Cook content for the target platform" />
  <Option Name="EnablePackage" DefaultValue="true" Restrict="true|false" Description="Package the game" />
  <Option Name="EnableTests" DefaultValue="true" Restrict="true|false" Description="Run automated tests" />
  <Option Name="ForceEngineRebuild" DefaultValue="false" Restrict="true|false" Description="Force rebuild of engine modules if needed" />

  <Option Name="AutomationTests" DefaultValue="Game.FPSCharacter.*" Description="Automation tests to run" />

  <Agent Name="Build Agent" Type="Win64">

    <Node Name="GenerateProjectFiles">
      <Log Message="Generating project files for $(ProjectName)..." />
      <Spawn Exe="$(RootDir)\Engine\Binaries\DotNET\UnrealBuildTool\UnrealBuildTool.exe" 
             Arguments="-ProjectFiles -Project=&quot;$(ProjectFile)&quot; -Game" />
      <Log Message="Project files generated successfully!" />
    </Node>

    <!-- Ensure Engine Prerequisites -->
    <Node Name="EnsureEnginePrerequisites" Requires="GenerateProjectFiles" If="$(ForceEngineRebuild)">
      <Log Message="Ensuring engine prerequisites are built..." />
      <Compile Target="UnrealEditor" 
               Platform="Win64"
               Configuration="$(BuildConfiguration)" />
      <Log Message="Engine prerequisites ensured" />
    </Node>

    <!-- Build Editor  -->
    <Node Name="BuildEditor" Requires="GenerateProjectFiles" Produces="#EditorBinaries" If="$(EnableEditor)">
      <Log Message="Building $(ProjectName) Editor..." />
      <Compile Target="$(ProjectName)Editor" 
               Platform="Win64"
               Configuration="$(BuildConfiguration)"
               Arguments="-NoHotReloadFromIDE"
               Project="$(ProjectFile)"
               Tag="#EditorBinaries" />
      <Log Message="Editor build complete" />
    </Node>

    <!-- Build Game Target -->
    <Node Name="BuildGame" Requires="GenerateProjectFiles" Produces="#GameBinaries" If="$(EnableGameBuild)">
      <Log Message="Building $(ProjectName) game target..." />
      <Compile Target="$(ProjectName)" 
               Platform="$(TargetPlatform)"
               Configuration="$(BuildConfiguration)" 
               Arguments="-NoHotReloadFromIDE"
               Project="$(ProjectFile)"
               Tag="#GameBinaries" />
      <Log Message="Game build complete" />
    </Node>

    <!-- Cook Content -->
    <Node Name="CookContent" Requires="BuildEditor" Produces="#CookedContent" If="$(EnableCook)">
      <Log Message="Cooking content for $(TargetPlatform)..." />
      <Property Name="CookPlatform" Value="$(TargetPlatform)" />
      <Property Name="CookPlatform" Value="Windows" If="'$(TargetPlatform)' == 'Win64'" />
      <Cook Project="$(ProjectFile)" Platform="$(CookPlatform)" />
      <Tag Files="$(ProjectRoot)\Saved\Cooked\..." With="#CookedContent" />
    </Node>

    <!-- Stage Project -->
    <Node Name="StageProject" Requires="BuildGame;CookContent" If="$(EnablePackage)">
      <Log Message="Staging project for $(TargetPlatform)..." />
      <Command Name="BuildCookRun" Arguments="
        -Project=&quot;$(ProjectFile)&quot; 
        -Platform=$(TargetPlatform) 
        -Configuration=$(BuildConfiguration) 
        -SkipBuild -SkipCook 
        -Stage -Pak 
        -NoCodeSign" />
      <Tag Files="$(ProjectRoot)\Saved\StagedBuilds\$(TargetPlatform)\..." With="#Staged" />
    </Node>

    <!-- Package Project -->
    <Node Name="PackageProject" Requires="StageProject" If="$(EnablePackage)">
      <Log Message="Packaging project for $(TargetPlatform)..." />
      <Command Name="BuildCookRun" Arguments="-Project=&quot;$(ProjectFile)&quot; -Platform=$(TargetPlatform) -Configuration=$(BuildConfiguration) -SkipBuild -SkipCook -SkipStage -SkipPak -Package -NoCodeSign" />
    </Node>

  </Agent>

  <Agent Name="Test Agent" Type="Win64">

    <Node Name="RunEditorTests" Requires="BuildEditor" If="$(EnableTests)">
      <Log Message="Running Editor Automation (Group:CI) via Gauntlet" />
      <Command Name="RunUnreal" Arguments="
        -project=&quot;$(ProjectFile)&quot;
        -platform=$(TargetPlatform)
        -configuration=$(BuildConfiguration)
        -test=UE.EditorAutomation
        -runtest=Group:CI
        -build=editor
        -reportdir=&quot;$(AutomationOutDir)\Editor\Gauntlet&quot;
        -ReportExportPath=&quot;$(AutomationOutDir)\Editor\Automation&quot;
        -timeout=18000
        -maxtestduration=18000
        -MaxDuration=18000
        -MaxTestDuration=18000
        -MaxTestDurationSeconds=18000
        -heartbeatperiod=60
        -unattended -nop4 -nosplash" />
    </Node>


<!--
    <Node Name="RunClientTests_UI" Requires="StageProject" If="$(EnableTests)">
      <Log Message="Running Client Automation (Group:UI) via Gauntlet" />
      <Command Name="RunUnreal" Arguments="
        -project=&quot;$(ProjectFile)&quot;
        -platform=$(TargetPlatform)
        -configuration=$(BuildConfiguration)
        -test=UE.TargetAutomation
        -runtest=Group:UI
        -build=local
        -reportdir=&quot;$(AutomationOutDir)\Client\UI&quot;
        -Timeout=1800"/>
    </Node>

    <Node Name="RunClientTests_Visual" Requires="StageProject" If="$(EnableTests)">
      <Log Message="Running Client Automation (Group:Visual) via Gauntlet" />
      <Command Name="RunUnreal" Arguments="
        -project=&quot;$(ProjectFile)&quot;
        -platform=$(TargetPlatform)
        -configuration=$(BuildConfiguration)
        -test=UE.TargetAutomation
        -runtest=Group:Visual
        -build=local
        -reportdir=&quot;$(AutomationOutDir)\Client\Visual&quot;
        -Timeout=1800"/>
    </Node>

    <Node Name="RunClientTests_Perf" Requires="StageProject" If="$(EnableTests)">
      <Log Message="Running Client Automation (Group:Perf) via Gauntlet" />
      <Command Name="RunUnreal" Arguments="
        -project=&quot;$(ProjectFile)&quot;
        -platform=$(TargetPlatform)
        -configuration=$(BuildConfiguration)
        -test=UE.TargetAutomation
        -runtest=Group:Perf
        -build=local
        -reportdir=&quot;$(AutomationOutDir)\Client\Perf&quot;"/>
    </Node>
     -->

    <Node Name="RunClientTests_AI" Requires="StageProject" If="$(EnableTests)">
      <Log Message="Running Client Automation (Group:AI) via Gauntlet" />
      <Command Name="RunUnreal" Arguments="
        -project=&quot;$(ProjectFile)&quot;
        -platform=$(TargetPlatform)
        -configuration=$(BuildConfiguration)
        -clientargs=&quot;-AITest&quot;
        -test=UE.TargetAutomation
        -runtest=Group:AI
        -build=local
        -reportdir=&quot;$(AutomationOutDir)\Client\AI\Gauntlet&quot;
        -ReportExportPath=&quot;$(AutomationOutDir)\Client\AI\Automation&quot;
        -timeout=18000
        -maxtestduration=18000
        -MaxDuration=18000
        -MaxTestDuration=18000
        -MaxTestDurationSeconds=18000
        -heartbeatperiod=60
        -unattended -nop4 -nosplash" />
    </Node>

    <Node Name="TestBlueprintCompilation" Requires="BuildEditor" If="$(EnableTests)">
      <Log Message="Testing Blueprint compilation..." />
      <Commandlet Name="CompileAllBlueprints" Project="$(ProjectFile)" />
      <Log Message="Blueprint compilation test complete!" />
      <Tag Files="$(AutomationOutDir)\..." With="#AutomationReports" If="$(EnableTests)" />
    </Node>
  </Agent>

  <Agent Name="Analysis Agent" Type="Win64">
    <Node Name="RunCodeAnalysis" Requires="GenerateProjectFiles">
      <Log Message="Running static code analysis..." />
      <Compile Target="$(ProjectName)Editor"
              Platform="Win64"
              Configuration="$(BuildConfiguration)"
              Project="$(ProjectFile)"
              Arguments="-StaticAnalyzer=Default -NoPCH -NoSharedPCH -DisableUnity -NoLink -NoHotReloadFromIDE" />
      <Log Message="Static code analysis complete!" />
    </Node>

    <Node Name="ValidateAssets" Requires="BuildEditor">
      <Log Message="Validating project assets..." />
      <Commandlet Name="DataValidation" Arguments="-Project=&quot;$(ProjectFile)&quot; -Unattended" />
      <Log Message="Asset validation complete!" />
    </Node>
  </Agent>

  <!-- Define what runs for each target -->
  <Property Name="BuildNodes" Value="GenerateProjectFiles" />
  <Property Name="BuildNodes" Value="$(BuildNodes);BuildEditor" If="$(EnableEditor)" />
  <Property Name="BuildNodes" Value="$(BuildNodes);BuildGame" If="$(EnableGameBuild)" />
  
  <Property Name="PackageNodes" Value="$(BuildNodes)" />
  <Property Name="PackageNodes" Value="$(PackageNodes);CookContent" If="$(EnableCook)" />
  <Property Name="PackageNodes" Value="$(PackageNodes);StageProject;PackageProject" If="$(EnablePackage)" />
  
  <Property Name="TestNodes" Value="" />
  <Property Name="TestNodes" Value="$(TestNodes);RunEditorTests;RunClientTests_AI;TestBlueprintCompilation" If="$(EnableTests)" />
  <!--<Property Name="TestNodes" Value="$(TestNodes);RunClientTests_UI" />
  <Property Name="TestNodes" Value="$(TestNodes);RunClientTests_Visual" /> 
  <Property Name="TestNodes" Value="$(TestNodes);RunClientTests_Perf" /> -->
  <Aggregate Name="Test" Requires="$(TestNodes)" If="'$(TestNodes)' != ''" />

  <Property Name="AnalysisNodes" Value="" />
  <Property Name="AnalysisNodes" Value="RunCodeAnalysis;ValidateAssets" />

  <!-- Target definitions -->
  <Aggregate Name="Build" Requires="$(BuildNodes)" />
  <Aggregate Name="Package" Requires="$(PackageNodes)" />
  <Aggregate Name="Analyze" Requires="$(AnalysisNodes)" If="'$(AnalysisNodes)' != ''" />
  
  <!-- Full CI target combines everything -->
  <Property Name="CINodes" Value="$(PackageNodes)" />
  <Property Name="CINodes" Value="$(CINodes);$(TestNodes)" If="$(EnableTests) And '$(TestNodes)' != ''" />
  <Property Name="CINodes" Value="$(CINodes);$(AnalysisNodes)" If="'$(AnalysisNodes)' != ''" />
  
  <Aggregate Name="CI" Requires="$(CINodes)" />
  <Aggregate Name="Default" Requires="CI" />
</BuildGraph>