<BuildGraph xmlns="http://www.epicgames.com/BuildGraph" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.epicgames.com/BuildGraph ../Schema.xsd">
  <Option Name="ProjectName" DefaultValue="" Description="Name of the project" />
  <Option Name="ProjectRoot" DefaultValue="" Description="Root directory of the project" />

  <Property Name="ProjectFile" Value="$(ProjectRoot)\$(ProjectName).uproject" />
  <Property Name="BuildOutputDir" Value="$(ProjectRoot)\Saved\StagedBuilds" />
  <Property Name="AutomationOutDir" Value="$(ProjectRoot)\Saved\Automation" />

  <Error Message="Project file $(ProjectFile) does not exist" If="!Exists('$(ProjectFile)')" />
  <Error Message="ProjectName must be specified via -set:ProjectName=..." If="'$(ProjectName)' == ''" />
  <Error Message="ProjectRoot must be specified via -set:ProjectRoot=..." If="'$(ProjectRoot)' == ''" />

  <Option Name="ProjectName" DefaultValue="" Description="Name of the project" />
  <Option Name="ProjectRoot" DefaultValue="" Description="Root directory of the project" />

  <Property Name="ProjectFile" Value="$(ProjectRoot)\$(ProjectName).uproject" />
  <Property Name="BuildOutputDir" Value="$(ProjectRoot)\Saved\StagedBuilds" />
  <Property Name="AutomationOutDir" Value="$(ProjectRoot)\Saved\Automation" />

  <Error Message="Project file $(ProjectFile) does not exist" If="!Exists('$(ProjectFile)')" />
  <Error Message="ProjectName must be specified via -set:ProjectName=..." If="'$(ProjectName)' == ''" />
  <Error Message="ProjectRoot must be specified via -set:ProjectRoot=..." If="'$(ProjectRoot)' == ''" />

  <Option Name="BuildConfiguration" DefaultValue="Development"
          Restrict="Debug|Development|Shipping|Test"
          Description="Build configuration" />
  <Option Name="TargetPlatform" DefaultValue="Win64"
          Restrict="Win64|Linux|Mac"
          Description="Target platform" />
  <Option Name="EnableEditor" DefaultValue="true"
          Restrict="true|false"
          Description="Build the editor" />
  <Option Name="EnableGameBuild" DefaultValue="true"
          Restrict="true|false"
          Description="Build the game target" />
  <Option Name="EnableCook" DefaultValue="true"
          Restrict="true|false"
          Description="Cook content" />
  <Option Name="EnablePackage" DefaultValue="true"
          Restrict="true|false"
          Description="Package the build" />
  <Option Name="EnableTests" DefaultValue="true"
          Restrict="true|false"
          Description="Run automated tests" />
  <Option Name="ForceEngineRebuild" DefaultValue="false"
          Restrict="true|false"
          Description="Force rebuild engine modules" />
  <Option Name="AutomationTests" DefaultValue="Game.FPSCharacter.*"
          Description="Automation test filter pattern" />


  <Agent Name="Build Agent" Type="Win64">
    <Node Name="GenerateProjectFiles">
      <Spawn Exe="$(RootDir)\Engine\Binaries\DotNET\UnrealBuildTool\UnrealBuildTool.exe" Arguments="-ProjectFiles -Project=&quot;$(ProjectFile)&quot; -Game" />
    </Node>

    <Node Name="EnsureEnginePrerequisites" Requires="GenerateProjectFiles" If="$(ForceEngineRebuild)">
      <Compile Target="UnrealEditor" Platform="Win64" Configuration="$(BuildConfiguration)" />
    </Node>

    <Node Name="BuildEditor" Requires="GenerateProjectFiles" Produces="#EditorBinaries" If="$(EnableEditor)">
      <Compile Target="$(ProjectName)Editor" Platform="Win64" Configuration="$(BuildConfiguration)" Arguments="-NoHotReloadFromIDE" Project="$(ProjectFile)" Tag="#EditorBinaries" />
    </Node>

    <Node Name="BuildGame" Requires="GenerateProjectFiles" Produces="#GameBinaries" If="$(EnableGameBuild)">
      <Compile Target="$(ProjectName)" Platform="$(TargetPlatform)" Configuration="$(BuildConfiguration)" Arguments="-NoHotReloadFromIDE" Project="$(ProjectFile)" Tag="#GameBinaries" />
    </Node>

    <Node Name="CookContent" Requires="BuildEditor" Produces="#CookedContent" If="$(EnableCook)">
      <Property Name="CookPlatform" Value="$(TargetPlatform)" />
      <Property Name="CookPlatform" Value="Windows" If="'$(TargetPlatform)' == 'Win64'" />
      <Cook Project="$(ProjectFile)" Platform="$(CookPlatform)" />
      <Tag Files="$(ProjectRoot)\Saved\Cooked\..." With="#CookedContent" />
    </Node>

    <Node Name="StageProject" Requires="BuildGame;CookContent" If="$(EnablePackage)">
      <Command Name="BuildCookRun" Arguments="-Project=&quot;$(ProjectFile)&quot; -Platform=$(TargetPlatform) -Configuration=$(BuildConfiguration) -SkipBuild -SkipCook -Stage -Pak -NoCodeSign" />
      <Tag Files="$(ProjectRoot)\Saved\StagedBuilds\$(TargetPlatform)\..." With="#Staged" />
    </Node>

    <Node Name="PackageProject" Requires="StageProject" If="$(EnablePackage)">
      <Command Name="BuildCookRun" Arguments="-Project=&quot;$(ProjectFile)&quot; -Platform=$(TargetPlatform) -Configuration=$(BuildConfiguration) -SkipBuild -SkipCook -SkipStage -SkipPak -Package -NoCodeSign" />
    </Node>
  </Agent>

  <Agent Name="Test Agent" Type="Win64">
    <Node Name="RunEditorTests" Requires="BuildEditor" If="$(EnableTests)">
      <Command Name="RunUnreal" Arguments="
        -project=&quot;$(ProjectFile)&quot;
        -platform=$(TargetPlatform)
        -configuration=$(BuildConfiguration)
        -test=UE.EditorAutomation
        -runtest=Group:CI
        -build=editor
        -reportdir=&quot;$(AutomationOutDir)\Editor\Gauntlet&quot;
        -ReportExportPath=&quot;$(AutomationOutDir)\Editor\Automation&quot;
        -reportall
        -reportexporters=xml
        -timeout=18000
        -maxtestduration=18000
        -heartbeatperiod=60
        -unattended -nop4 -nosplash" />
    </Node>

    <Node Name="RunClientTests_Func" Requires="StageProject" If="$(EnableTests)">
      <Command Name="RunUnreal" Arguments="
        -project=&quot;$(ProjectFile)&quot;
        -platform=$(TargetPlatform)
        -configuration=$(BuildConfiguration)
        -test=UE.TargetAutomation
        -runtest=Group:Func
        -build=local
        -reportdir=&quot;$(AutomationOutDir)\Client\Func\Gauntlet&quot;
        -ReportExportPath=&quot;$(AutomationOutDir)\Client\Func\Automation&quot;
        -reportall
        -reportexporters=xml" />
    </Node>

    <Node Name="RunClientTests_AI" Requires="StageProject" If="$(EnableTests)">
      <Command Name="RunUnreal" Arguments="
        -project=&quot;$(ProjectFile)&quot;
        -platform=$(TargetPlatform)
        -configuration=$(BuildConfiguration)
        -clientargs=&quot;-AITest&quot;
        -test=UE.TargetAutomation
        -runtest=Group:AI
        -build=local
        -reportdir=&quot;$(AutomationOutDir)\Client\AI\Gauntlet&quot;
        -ReportExportPath=&quot;$(AutomationOutDir)\Client\AI\Automation&quot;
        -reportall
        -reportexporters=xml
        -timeout=18000
        -maxtestduration=18000
        -heartbeatperiod=60
        -unattended -nop4 -nosplash" />
    </Node>

    <Node Name="TestBlueprintCompilation" Requires="BuildEditor" If="$(EnableTests)">
      <Commandlet Name="CompileAllBlueprints" Project="$(ProjectFile)" />
      <Tag Files="$(AutomationOutDir)\..." With="#AutomationReports" If="$(EnableTests)" />
    </Node>

    <Node Name="CollectArtifacts" Requires="RunEditorTests;RunClientTests_Func;RunClientTests_AI" If="$(EnableTests)">
      <Spawn Exe="powershell.exe" Arguments="-NoProfile -ExecutionPolicy Bypass -Command ^
        $Root='$(ProjectRoot)'; ^
        $B=Join-Path $Root 'Saved\Automation\_Bundle'; ^
        if (Test-Path $B){Remove-Item -Recurse -Force $B}; ^
        New-Item -ItemType Directory -Path $B | Out-Null; ^
        foreach($p in 'Saved\Automation\Editor\Automation','Saved\Automation\Client\Func\Automation','Saved\Automation\Client\AI\Automation'){ ^
          $src=Join-Path $Root $p; if(Test-Path $src){robocopy $src (Join-Path $B (Split-Path $p -Leaf)) *.xml *.json *.html /E | Out-Null} ^
        }; ^
        $top=Join-Path $Root 'Saved\Automation'; ^
        if(Test-Path (Join-Path $top 'index.json')){Copy-Item (Join-Path $top 'index.*') $B -ErrorAction SilentlyContinue}; ^
        $bot=Join-Path $Root 'Saved\Automation\BotResults\Latest.json'; ^
        if(Test-Path $bot){New-Item -ItemType Directory -Path (Join-Path $B 'BotResults') -Force | Out-Null; Copy-Item $bot (Join-Path $B 'BotResults')}; ^
        $logs=Join-Path $Root 'Saved\Logs'; ^
        if(Test-Path $logs){New-Item -ItemType Directory -Path (Join-Path $B 'Logs') -Force | Out-Null; robocopy $logs (Join-Path $B 'Logs') *.log /E | Out-Null}; ^
        $auto=Join-Path $Root 'PerformanceTestResults_Automation.csv'; if(Test-Path $auto){Copy-Item $auto (Join-Path $B 'Performance_Automation.csv')}; ^
        $arch=Join-Path $Root 'ArchiveDirectory'; ^
        if(Test-Path $arch){$latest=Get-ChildItem $arch -Filter 'PerformanceTestResults_*.csv' | Sort-Object LastWriteTime -Descending | Select-Object -First 1; if($latest){Copy-Item $latest.FullName (Join-Path $B 'Performance_Archive_Latest.csv')}}"
      />
    </Node>

    <Node Name="EnsureJUnit" Requires="CollectArtifacts" If="$(EnableTests)">
      <Spawn Exe="powershell.exe" Arguments="-NoProfile -ExecutionPolicy Bypass -Command ^
        $B='$(ProjectRoot)\Saved\Automation\_Bundle'; ^
        if(!(Test-Path $B)){exit 0}; ^
        $hasXml=(Get-ChildItem -Path $B -Recurse -Filter *.xml -ErrorAction SilentlyContinue | Measure-Object).Count -gt 0; ^
        if($hasXml){exit 0}; ^
        $jsons=Get-ChildItem -Path $B -Recurse -Filter index.json -ErrorAction SilentlyContinue; ^
        foreach($j in $jsons){ ^
          $suite=Split-Path $j.DirectoryName -Leaf; ^
          $xmlPath=Join-Path $j.DirectoryName 'junit-converted.xml'; ^
          $doc=New-Object System.Xml.XmlDocument; ^
          $root=$doc.CreateElement('testsuite'); ^
          $null=$root.SetAttribute('name',$suite); ^
          $null=$root.SetAttribute('tests','0'); ^
          $null=$root.SetAttribute('failures','0'); ^
          $null=$root.SetAttribute('errors','0'); ^
          $null=$doc.AppendChild($root); ^
          $doc.Save($xmlPath) ^
        }" />
    </Node>
  </Agent>

  <Agent Name="Analysis Agent" Type="Win64">
    <Node Name="RunCodeAnalysis" Requires="GenerateProjectFiles">
      <Compile Target="$(ProjectName)Editor" Platform="Win64" Configuration="$(BuildConfiguration)" Project="$(ProjectFile)" Arguments="-StaticAnalyzer=Default -NoPCH -NoSharedPCH -DisableUnity -NoLink -NoHotReloadFromIDE" />
    </Node>

    <Node Name="ValidateAssets" Requires="BuildEditor">
      <Commandlet Name="DataValidation" Arguments="-Project=&quot;$(ProjectFile)&quot; -Unattended" />
    </Node>
  </Agent>

  <Property Name="BuildNodes" Value="GenerateProjectFiles" />
  <Property Name="BuildNodes" Value="$(BuildNodes);BuildEditor" If="$(EnableEditor)" />
  <Property Name="BuildNodes" Value="$(BuildNodes);BuildGame" If="$(EnableGameBuild)" />

  <Property Name="PackageNodes" Value="$(BuildNodes)" />
  <Property Name="PackageNodes" Value="$(PackageNodes);CookContent" If="$(EnableCook)" />
  <Property Name="PackageNodes" Value="$(PackageNodes);StageProject;PackageProject" If="$(EnablePackage)" />

  <Property Name="TestNodes" Value="" />
  <Property Name="TestNodes" Value="$(TestNodes);RunEditorTests;RunClientTests_Func;RunClientTests_AI" If="$(EnableTests)" />
  <Property Name="TestNodes" Value="$(TestNodes);CollectArtifacts;EnsureJUnit" If="$(EnableTests)" />
  <Aggregate Name="Test" Requires="$(TestNodes)" If="'$(TestNodes)' != ''" />

  <Property Name="AnalysisNodes" Value="" />
  <Property Name="AnalysisNodes" Value="RunCodeAnalysis;ValidateAssets" />

  <Aggregate Name="Build" Requires="$(BuildNodes)" />
  <Aggregate Name="Package" Requires="$(PackageNodes)" />
  <Aggregate Name="Analyze" Requires="$(AnalysisNodes)" If="'$(AnalysisNodes)' != ''" />

  <Property Name="CINodes" Value="$(PackageNodes)" />
  <Property Name="CINodes" Value="$(CINodes);$(TestNodes)" If="$(EnableTests) And '$(TestNodes)' != ''" />
  <Property Name="CINodes" Value="$(CINodes);$(AnalysisNodes)" If="'$(AnalysisNodes)' != ''" />

  <Aggregate Name="CI" Requires="$(CINodes)" />
  <Aggregate Name="Default" Requires="CI" />
</BuildGraph>
